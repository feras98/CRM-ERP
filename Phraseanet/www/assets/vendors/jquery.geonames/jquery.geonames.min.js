!function(t,e){"use strict";var n=function(t){return t=t||"",t+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},i=function(t,e){if(this.datas=e||{},!t instanceof r)throw"You must provide an instance of GeotoCompleter";t.getOption("sort")&&(this.datas.sort=t.getOption("sort")),t.getOption("client-ip")&&(this.datas.sortParams=t.getOption("sortParams")),t.getOption("country")&&(this.datas.country=t.getOption("country")),t.getOption("name")&&(this.datas.name=t.getOption("name")),t.getOption("limit")&&(this.datas.limit=t.getOption("limit"))};i.prototype.getRequestDatas=function(){return this.datas};var o=function(t){var n=!1,i=t;this.search=function(t,o,r,a){n=e.ajax({type:"GET",dataType:"jsonp",jsonpCallback:"parseresults",url:i+t,beforeSend:function(){n&&"function"==typeof n.abort&&n.abort()},error:r,data:o}).done(a).always(function(){n=!1})}},r=function(t,n,i){if("undefined"==typeof e.ui)throw"jQuery UI must be loaded";if(e(t).data("geocompleter"))return e(t).data("geocompleter");var r="/"===n.substr(n.length-1)?n:n+"/";this._requestManager=new o(r),this.$el=e(t),this._opts=e.extend({name:null,sort:null,"client-ip":null,country:null,limit:null,"init-input":!0},i),this.$input=null,this.$el.data("geocompleter",this)};r.prototype.getOption=function(t){return t in this._opts?this._opts[t]:null},r.prototype.setOption=function(t,e){return t in this._opts?(this._opts[t]=e,this):this},r.prototype.getAutocompleter=function(){return this.$input},r.prototype.destroy=function(){this.$input&&(this.$input.remove(),this.$el.show(),this.$el.val(""),this.$el.data("geocompleter",null))},r.prototype.init=function(){if(null===this.$input){var t=this,o=function(e){t.$el.val(e)},r=function(){t.$el.val("")},a=function(){t.$input.val("")},u=function(){return""!==t.$el.val()},s=function(t,n){var i=new RegExp("("+e.ui.autocomplete.escapeRegex(n)+")","ig");return t.replace(i,"<span class='ui-state-highlight'>$1</span>")};this.$input=e("<input />").attr("name",n(this.$el.attr("name"))).attr("id",n(this.$el.attr("id"))).attr("type","text").attr("class",this.$el.attr("class")).addClass("geocompleter-input"),this.$input.keypress(function(t){var n=t.keyCode?t.keyCode:t.which;if(n===e.ui.keyCode.ENTER)return t.preventDefault(),!1}),this.$input.keyup(function(t){var n=t.keyCode?t.keyCode:t.which,i=[e.ui.keyCode.ESCAPE,e.ui.keyCode.UP,e.ui.keyCode.DOWN,e.ui.keyCode.LEFT,e.ui.keyCode.RIGHT,e.ui.keyCode.ENTER];-1===e.inArray(n,i)&&r()}),this.$el.hide(),this.$el.after(this.$input),e.ui.autocomplete.prototype._renderItem=function(t,n){return e("<li></li>").data("item.autocomplete",n).append(e("<a></a>").html(n.label)).appendTo(t)};var p;this.$input.autocomplete({create:function(e){""!==t.$el.val()&&t.getOption("init-input")&&t._requestManager.search("city/"+parseInt(t.$el.val(),10),{},function(t,e,n){},function(e){var n=e.country.name||"";t.$input.val(e.name+(""!==n?","+n:""))})},source:function(n,o){var r,a,u="";u=n.term.split(","),2===u.length&&(a=u.pop()),r=u.pop(),t.setOption("name",e.trim(r)),t.setOption("country",e.trim(a));var p=new i(t);t._requestManager.search("city",p.getRequestDatas(),function(e,n,i){0!==e.status&&"abort"!==e.statusText&&(o([]),t.$input.trigger("geotocompleter.request.error",[e,n,i]))},function(t){o(e.map(t||[],function(t){var e=e?e:r,n=s(t.name,r),i=s(t.country?t.country.name||"":"",e),o=s(t.region?t.region.name||"":"",r);return{label:n+(""!==i?", "+i:"")+(""!==o?" <span class='region'>"+o+"</span>":""),value:t.name+(t.country?", "+t.country.name:""),geonameid:t.geonameid}}))})},messages:{noResults:"",results:function(){}},response:function(n,i){if(p=[],i.content&&(p=i.content,i.content.length>0)){var r=e.grep(i.content,function(e){return e.value===t.$input.val()?e:null});r.length>0&&o(r[0].geonameid)}},select:function(t,e){e.item&&o(e.item.geonameid)},focus:function(t,n){var i=t.keyCode?t.keyCode:t.which;n.item&&-1!==e.inArray(i,[e.ui.keyCode.DOWN,e.ui.keyCode.UP])&&o(n.item.geonameid)},close:function(n,i){var o=n.originalEvent;if("undefined"==typeof o)return!1;var s=o.keyCode?o.keyCode:o.which;if("keydown"===o.type&&s===e.ui.keyCode.ESCAPE||"blur"===o.type){if(u()&&p.length>0){var l=t.$el.val(),c=e.grep(p,function(t){return t.geonameid===l?t:null});return c.length>0&&t.$input.val(c[0].value),!1}r(),a()}}}).autocomplete("widget").addClass("geocompleter-menu");var l=t.getOption("onInit");null!==l&&"function"==typeof l&&l(this.$el,this.$input)}};var a={init:function(t){var n=e.extend({server:""},t);if(""===n.server)throw'"server" must be set';return this.each(function(){var t=new r(this,n.server,n);t.init()})},destroy:function(){return this.each(function(){var t=e(this).data("geocompleter");t&&t.destroy()})},autocompleter:function(){var t=arguments;return this.each(function(){var n=e(this).data("geocompleter");"on"===t[0]&&"string"==typeof t[1]&&"function"==typeof t[2]?n.getAutocompleter().on(t[1],t[2]):e.fn.autocomplete.apply(n.getAutocompleter(),t)})}};e.fn.geocompleter=function(t){return a[t]?a[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.geocompleter"):a.init.apply(this,arguments)}}(window,jQuery);